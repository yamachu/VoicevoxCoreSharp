name: CI

on: push

jobs:
  build-native-dev-library:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./binding
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - uses: actions/cache/restore@v3
      id: restore-dev-library
      with:
        path: ./binding/voicevox_core/target/release/libvoicevox_core.so
        key: ${{ runner.os }}-dev-library-${{ hashFiles('**/Cargo.lock', '**/VoicevoxCoreSharp.Core.Metas.props') }}
    - if: ${{ steps.restore-dev-library.outputs.cache-hit != 'true' }}
      uses: actions-rust-lang/setup-rust-toolchain@v1.5.0
    - if: ${{ steps.restore-dev-library.outputs.cache-hit != 'true' }}
      run: make build/dev-library
    - if: ${{ steps.restore-dev-library.outputs.cache-hit != 'true' }}
      uses: actions/cache/save@v3
      with:
        path: ./binding/voicevox_core/target/release/libvoicevox_core.so
        key: ${{ runner.os }}-dev-library-${{ hashFiles('**/Cargo.lock', '**/VoicevoxCoreSharp.Core.Metas.props') }}

  test-dotnet:
    runs-on: ubuntu-latest
    needs: build-native-dev-library
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6
    - uses: actions/cache/restore@v3
      with:
        path: ./binding/voicevox_core/target/release/libvoicevox_core.so
        key: ${{ runner.os }}-dev-library-${{ hashFiles('**/Cargo.lock', '**/VoicevoxCoreSharp.Core.Metas.props') }}
    - run: cp ./binding/voicevox_core/target/release/libvoicevox_core.so ./tests/VoicevoxCoreSharp.Core.Tests/resources/libvoicevox_core.so
    - uses: actions/cache/restore@v3
      id: restore-open-jtalk-dictionary
      with:
        path: open_jtalk_dic_utf_8-1.11.tar.gz
        key: open_jtalk_dic_utf_8-1.11
    - if: ${{ steps.restore-open-jtalk-dictionary.outputs.cache-hit != 'true' }}
      run: curl -sSLfo open_jtalk_dic_utf_8-1.11.tar.gz https://jaist.dl.sourceforge.net/project/open-jtalk/Dictionary/open_jtalk_dic-1.11/open_jtalk_dic_utf_8-1.11.tar.gz
    - if: ${{ steps.restore-open-jtalk-dictionary.outputs.cache-hit != 'true' }}
      uses: actions/cache/save@v3
      with:
        path: open_jtalk_dic_utf_8-1.11.tar.gz
        key: open_jtalk_dic_utf_8-1.11
    - run: |
        cp open_jtalk_dic_utf_8-1.11.tar.gz ./tests/VoicevoxCoreSharp.Core.Tests/resources
        tar zxf ./tests/VoicevoxCoreSharp.Core.Tests/resources/open_jtalk_dic_utf_8-1.11.tar.gz -C tests/VoicevoxCoreSharp.Core.Tests/resources/
    - run: cp -r binding/voicevox_core/model ./tests/VoicevoxCoreSharp.Core.Tests/resources
    - run: dotnet test
